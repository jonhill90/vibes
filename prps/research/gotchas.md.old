# Gotchas and Pitfalls: Devcontainer-Vibesbox Integration

**Feature:** Automatic vibesbox lifecycle management in VS Code devcontainer
**Research Date:** 2025-10-04
**Sources:** Archon knowledge base, OWASP Docker Security, VNC security best practices

## Summary

18 critical gotchas identified with solutions:
- ðŸ”´ Critical: 4 (Docker socket, VNC passwords, RunC CVE, overrideCommand)
- ðŸŸ  High: 6 (Race conditions, resource limits, network exposure)
- ðŸŸ¡ Medium: 5 (Config, architecture, UX)
- ðŸŸ¢ Low: 3 (Progress indicators)

## Key Security Gotchas

### 1. Docker Socket Exposure (CRITICAL)
- **Problem**: Mounting /var/run/docker.sock = root access
- **Solution**: Use Docker-in-Docker with proper isolation, minimal capabilities
- **Prevention**: Audit all docker commands, use read-only mounts

### 2. VNC Password Weakness (CRITICAL)
- **Problem**: Weak/default passwords allow unauthorized access
- **Solution**: Generate 32+ char passwords, use TLS encryption, bind to localhost
- **Prevention**: Secrets management, rate limiting, SSH tunnels

### 3. RunC CVE-2024-21626 (CRITICAL)
- **Problem**: Container escape vulnerability
- **Solution**: Update to Docker 25.0.3+ or 24.0.8+, use AppArmor
- **Prevention**: Automated updates, CVE monitoring

### 4. Privileged Mode Abuse (HIGH)
- **Problem**: --privileged removes all security boundaries
- **Solution**: Use minimal capabilities (SYS_ADMIN, NET_ADMIN only)
- **Prevention**: Audit capabilities, consider systemd alternatives

## Key Reliability Gotchas

### 5. Docker Daemon Not Ready (HIGH)
- **Problem**: postCreateCommand runs before daemon ready
- **Solution**: Wait loop checking `docker info` with 30s timeout
- **Prevention**: Use postStartCommand, log daemon startup

### 6. VNC Display Not Ready (HIGH)
- **Problem**: Health checks fail, X server not initialized
- **Solution**: Verify both xdpyinfo and port 5901 before testing
- **Prevention**: Retry loops with exponential backoff

### 7. Container Name Conflicts (MEDIUM)
- **Problem**: Multiple workspaces create same container name
- **Solution**: Use unique project names per workspace
- **Prevention**: Label-based ownership tracking

### 8. Network Already Exists (MEDIUM)
- **Problem**: docker network create fails if exists
- **Solution**: Idempotent creation - check before create
- **Prevention**: Document network ownership

## Performance Gotchas

### 9. Slow Startup (HIGH) 
- **Problem**: 30-60s startup blocks devcontainer
- **Solution**: Parallel service startup, BuildKit caching, pre-pull images
- **Target**: Cold <20s, warm <10s

### 10. Resource Exhaustion (HIGH)
- **Problem**: No limits, vibesbox can starve host
- **Solution**: Set CPU (2.0), memory (2G) limits
- **Prevention**: Monitor with docker stats

### 11. VNC Lag (MEDIUM)
- **Problem**: 10-15 FPS, slow automation
- **Solution**: Optimize x11vnc (-ncache, -threads, -noxdamage)
- **Target**: Screenshot <1s

## Configuration Gotchas

### 12. Missing overrideCommand (CRITICAL)
- **Problem**: DinD doesn't start, devcontainer hangs
- **Solution**: Always set "overrideCommand": false with DinD
- **Prevention**: Document, validate, test

### 13. Architecture Mismatch (MEDIUM)
- **Problem**: amd64 image fails on arm64
- **Solution**: Multi-platform builds, ${PLATFORM:-linux/arm64}
- **Prevention**: Document supported architectures

### 14. Environment Variable Precedence (MEDIUM)
- **Problem**: Variables ignored, defaults used
- **Solution**: Use ${VAR:-default} syntax consistently
- **Prevention**: Validate before operations

## UX Gotchas

### 15. Unclear Error Messages (MEDIUM)
- **Problem**: Raw Docker errors without context
- **Solution**: Catch patterns, provide remediation steps
- **Prevention**: Test common failure modes

### 16. No Progress Feedback (LOW)
- **Problem**: Silent builds, users think it's hung
- **Solution**: Show progress (--progress=plain), use spinners
- **Prevention**: Always indicate for >5s operations

## Prevention Checklist

**Security:**
- [ ] Docker socket read-only where possible
- [ ] VNC password 32+ chars, TLS enabled
- [ ] Docker 25.0.3+ (CVE-2024-21626)
- [ ] Minimal capabilities, no --privileged
- [ ] VNC localhost-only binding

**Reliability:**
- [ ] Wait for Docker daemon (30s timeout)
- [ ] Verify VNC readiness (xdpyinfo + port 5901)
- [ ] Idempotent network creation
- [ ] Unique container names
- [ ] Retry logic with backoff

**Performance:**
- [ ] Resource limits (CPU, memory)
- [ ] BuildKit caching
- [ ] Parallel startup
- [ ] VNC optimization

**Configuration:**
- [ ] overrideCommand: false for DinD
- [ ] Multi-platform images
- [ ] Environment variable defaults
- [ ] Architecture validation

**UX:**
- [ ] Helpful error messages
- [ ] Progress indicators
- [ ] Time estimates
- [ ] Graceful degradation

## Testing Commands

```bash
# Security audit
docker inspect vibesbox | jq '.[0].HostConfig.CapAdd'
docker port vibesbox | grep -v 127.0.0.1

# Reliability testing
for i in {1..10}; do
    docker compose down && docker compose up -d
    wait_for_vnc || echo "FAILED: $i"
done

# Performance benchmarks
time docker compose up -d vibesbox
time wait_for_vnc
time docker exec vibesbox env DISPLAY=:1 import -window root test.png
```

## References

1. OWASP Docker Security: https://cheatsheetseries.owasp.org/
2. CVE-2024-21626: https://www.docker.com/blog/docker-security-advisory/
3. CIS Docker Benchmark: https://www.cisecurity.org/benchmark/docker
4. Devcontainer Lifecycle: https://containers.dev/implementors/json_reference/
5. BuildKit Docs: https://docs.docker.com/build/buildkit/

**Total: 18 gotchas documented with solutions**
